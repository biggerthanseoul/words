<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI 영어 단어 학습 앱</title>
  <!-- 온디바이스 AI 라이브러리 추가 -->
  <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1"></script>
  <style>
    :root {
      --meaning-bg: #2c3e50;
      --meaning-dark: #22303f;
      --light-gray: #ecf0f1;
      --text-gray: #7f8c8d;
      --accent-blue: #3498db;
      --accent-blue-dark: #2980b9;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', 'Noto Sans KR', sans-serif;
    }
    body {
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      text-align: center;
      margin-bottom: 20px;
    }
    h1 {
      font-size: 2rem;
      color: #2c3e50;
      margin-bottom: 10px;
    }
    .lang-tabs {
      text-align: center;
      margin-bottom: 20px;
    }
    .lang-btn {
      padding: 8px 16px;
      margin: 0 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .lang-btn.active {
      background-color: var(--meaning-bg);
      color: white;
    }
    .lang-btn:not(.active) {
      background-color: var(--light-gray);
      color: var(--text-gray);
    }
    .instructions {
      text-align: center;
      margin: 0 0 20px;
      color: var(--text-gray);
      font-size: 0.9rem;
    }
    .chapter-container {
      margin-bottom: 40px;
    }
    .chapter-title {
      background-color: var(--meaning-bg);
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      margin-bottom: 15px;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }
    .chapter-title:hover {
      background-color: var(--meaning-dark);
    }
    .chapter-toggle {
      font-size: 1.2rem;
    }
    .words-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease-out;
    }
    .words-container.expanded {
      max-height: 5000px;
      transition: max-height 0.5s ease-in;
    }
    .word-card {
      width: calc(33.333% - 10px);
      height: 100px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      background-color: white;
      overflow: hidden;
      position: relative;
      perspective: 1000px;
      cursor: pointer;
    }
    @media (max-width: 768px) {
      .word-card {
        width: calc(50% - 10px);
      }
    }
    @media (max-width: 480px) {
      .word-card {
        width: 100%;
      }
    }
    .card-slider {
      width: 300%;
      height: 100%;
      display: flex;
      transition: transform 0.3s ease;
    }
    .card-face {
      width: 33.333%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      text-align: center;
    }
    .word-face {
      background-color: #fff;
      color: #2c3e50;
    }
    .pronunciation-face {
      background-color: var(--light-gray);
      color: var(--text-gray);
      font-family: 'Arial', sans-serif;
    }
    .meaning-face {
      background-color: var(--meaning-bg);
      color: white;
    }
    .word-text {
      font-size: 1.5rem;
      font-weight: bold;
    }
    .pronunciation-text {
      font-size: 1.3rem;
      font-style: italic;
    }
    .meaning-text {
      font-size: 1.3rem;
    }
    .navigation {
      position: absolute;
      bottom: 10px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 8px;
    }
    .nav-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #bdc3c7;
      cursor: pointer;
    }
    .nav-dot.active {
      background-color: #415163;
    }
    
    /* AI 문장 생성 기능 CSS */
    .generate-btn {
      position: absolute;
      right: 50px;
      top: 50%;
      transform: translateY(-50%);
      padding: 4px 8px;
      font-size: 0.8rem;
      background-color: var(--accent-blue);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      min-width: 90px;
      text-align: center;
      transition: background-color 0.2s;
    }
    .generate-btn:hover {
      background-color: var(--accent-blue-dark);
    }
    .generate-btn:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }
    .sentence-display {
      background-color: #ecf0f1;
      border-left: 4px solid var(--accent-blue);
      padding: 15px;
      margin-top: 15px;
      border-radius: 4px;
      font-style: italic;
      color: #34495e;
      display: none;
      white-space: pre-wrap;
      position: relative;
    }
    .sentence-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .tts-btn {
      padding: 2px 6px;
      font-size: 0.7rem;
      background-color: #27ae60;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .tts-btn:hover {
      background-color: #219a52;
    }
    .tts-btn:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }
    .sentence-text {
      font-size: 1.1rem;
      margin-bottom: 10px;
      line-height: 1.4;
    }
    .korean-translation {
      font-size: 0.9rem;
      color: #7f8c8d;
      font-style: normal;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <!-- 로그인 화면 -->
  <div id="login-screen" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh;">
    <h2>로그인</h2>
    <input type="password" id="password-input" placeholder="비밀번호 입력" style="padding: 8px; font-size: 1rem; margin-bottom: 10px;"/>
    <button id="login-btn" style="padding: 8px 16px; font-size: 1rem;">로그인</button>
    <p id="login-error" style="color: red; visibility: hidden; margin-top: 8px;">비밀번호가 올바르지 않습니다.</p>
  </div>

  <!-- 실제 앱 화면 -->
  <div id="app" style="display: none;">
    <div class="container">
      <header>
        <h1>AI 영어 단어 학습 앱</h1>
      </header>
      <div class="lang-tabs">
        <button class="lang-btn active" data-face="0">English</button>
        <button class="lang-btn" data-face="2">한글</button>
      </div>
      <p class="instructions">
        • 카드 클릭 시 영어 단어면에서 원어민 목소리로 발음이 재생됩니다.<br/>
        • '문장 만들기' 버튼으로 AI가 유닛 단어를 활용해 매번 다른 예문을 만들어줍니다.<br/>
        • 생성된 문장은 영어/한국어 음성으로 읽을 수 있습니다.
      </p>
      <div id="chapters-list">
        <div class="loading">데이터 로딩 중...</div>
      </div>
    </div>
  </div>

  <script>
    const CORRECT_PASSWORD = '0410';
    let defaultFaceIndex = 0;
    let englishVoice = null;
    let koreanVoice = null;
    let generator = null; // 온디바이스 AI 생성기

    // 로그인 처리
    document.getElementById('login-btn').addEventListener('click', () => {
      const pwd = document.getElementById('password-input').value;
      if (pwd === CORRECT_PASSWORD) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        loadVoices();
        initializeApp();
      } else {
        document.getElementById('login-error').style.visibility = 'visible';
      }
    });

    // 단어 데이터 (기존과 동일)
    const vocabData = [
      { title: "Unit 1: Special Days", words: [
        { word: "Valentine's Day", pronunciation: "/ˈvæləntaɪnz deɪ/", meaning: "발렌타인 데이" },
        { word: "Earth Day", pronunciation: "/ɜːrθ deɪ/", meaning: "지구의 날" },
        { word: "Mother's Day", pronunciation: "/ˈmʌðərz deɪ/", meaning: "어머니의 날" },
        { word: "Thanksgiving", pronunciation: "/ˌθæŋksˈɡɪvɪŋ/", meaning: "추수감사절" },
        { word: "Halloween", pronunciation: "/ˌhæləˈwiːn/", meaning: "할로윈" },
        { word: "Christmas Day", pronunciation: "/ˈkrɪsməs deɪ/", meaning: "크리스마스" },
        { word: "favorite", pronunciation: "/ˈfeɪvərɪt/", meaning: "가장 좋아하는" },
        { word: "day", pronunciation: "/deɪ/", meaning: "날" },
        { word: "my", pronunciation: "/maɪ/", meaning: "나의" },
        { word: "his", pronunciation: "/hɪz/", meaning: "그의" },
        { word: "her", pronunciation: "/hɜːr/", meaning: "그녀의" },
        { word: "what", pronunciation: "/wɑːt/", meaning: "무엇" },
        { word: "look", pronunciation: "/lʊk/", meaning: "보다" },
        { word: "make", pronunciation: "/meɪk/", meaning: "만들다" },
        { word: "cards", pronunciation: "/kɑːrdz/", meaning: "카드" },
        { word: "give", pronunciation: "/ɡɪv/", meaning: "주다" },
        { word: "presents", pronunciation: "/ˈprezənts/", meaning: "선물" },
        { word: "eat", pronunciation: "/iːt/", meaning: "먹다" },
        { word: "turkey", pronunciation: "/ˈtɜːrki/", meaning: "칠면조" },
        { word: "mom", pronunciation: "/mɑːm/", meaning: "엄마" },
        { word: "I", pronunciation: "/aɪ/", meaning: "나" },
        { word: "you", pronunciation: "/juː/", meaning: "너" },
        { word: "he", pronunciation: "/hiː/", meaning: "그" },
        { word: "she", pronunciation: "/ʃiː/", meaning: "그녀" },
        { word: "we", pronunciation: "/wiː/", meaning: "우리" },
        { word: "they", pronunciation: "/ðeɪ/", meaning: "그들" },
        { word: "love", pronunciation: "/lʌv/", meaning: "사랑하다" },
        { word: "happy", pronunciation: "/ˈhæpi/", meaning: "행복한" },
        { word: "special", pronunciation: "/ˈspeʃəl/", meaning: "특별한" },
        { word: "celebrate", pronunciation: "/ˈseləbreɪt/", meaning: "축하하다" }
      ]},
      { title: "Unit 2: Today's Weather", words: [
        { word: "sunny", pronunciation: "/ˈsʌni/", meaning: "맑은" },
        { word: "rainy", pronunciation: "/ˈreɪni/", meaning: "비가 내리는" },
        { word: "cloudy", pronunciation: "/ˈklaʊdi/", meaning: "구름 낀" },
        { word: "windy", pronunciation: "/ˈwɪndi/", meaning: "바람이 부는" },
        { word: "snowy", pronunciation: "/ˈsnoʊi/", meaning: "눈이 내리는" },
        { word: "weather", pronunciation: "/ˈweðər/", meaning: "날씨" },
        { word: "today", pronunciation: "/təˈdeɪ/", meaning: "오늘" },
        { word: "hot", pronunciation: "/hɑːt/", meaning: "더운" },
        { word: "cold", pronunciation: "/koʊld/", meaning: "추운" },
        { word: "warm", pronunciation: "/wɔːrm/", meaning: "따뜻한" },
        { word: "cool", pronunciation: "/kuːl/", meaning: "시원한" },
        { word: "beautiful", pronunciation: "/ˈbjuːtɪfəl/", meaning: "아름다운" },
        { word: "nice", pronunciation: "/naɪs/", meaning: "좋은" },
        { word: "terrible", pronunciation: "/ˈterəbəl/", meaning: "끔찍한" },
        { word: "outside", pronunciation: "/ˌaʊtˈsaɪd/", meaning: "밖에" },
        { word: "inside", pronunciation: "/ˌɪnˈsaɪd/", meaning: "안에" },
        { word: "umbrella", pronunciation: "/ʌmˈbrelə/", meaning: "우산" },
        { word: "jacket", pronunciation: "/ˈdʒækɪt/", meaning: "재킷" },
        { word: "stay", pronunciation: "/steɪ/", meaning: "머무르다" },
        { word: "go", pronunciation: "/ɡoʊ/", meaning: "가다" }
      ]},
      { title: "Unit 3: Food & Shopping", words: [
        { word: "apple", pronunciation: "/ˈæpəl/", meaning: "사과" },
        { word: "banana", pronunciation: "/bəˈnænə/", meaning: "바나나" },
        { word: "orange", pronunciation: "/ˈɔːrɪndʒ/", meaning: "오렌지" },
        { word: "bread", pronunciation: "/bred/", meaning: "빵" },
        { word: "milk", pronunciation: "/mɪlk/", meaning: "우유" },
        { word: "cheese", pronunciation: "/tʃiːz/", meaning: "치즈" },
        { word: "chicken", pronunciation: "/ˈtʃɪkɪn/", meaning: "닭고기" },
        { word: "rice", pronunciation: "/raɪs/", meaning: "쌀" },
        { word: "water", pronunciation: "/ˈwɔːtər/", meaning: "물" },
        { word: "juice", pronunciation: "/dʒuːs/", meaning: "주스" },
        { word: "buy", pronunciation: "/baɪ/", meaning: "사다" },
        { word: "sell", pronunciation: "/sel/", meaning: "팔다" },
        { word: "store", pronunciation: "/stɔːr/", meaning: "가게" },
        { word: "market", pronunciation: "/ˈmɑːrkɪt/", meaning: "시장" },
        { word: "fresh", pronunciation: "/freʃ/", meaning: "신선한" },
        { word: "delicious", pronunciation: "/dɪˈlɪʃəs/", meaning: "맛있는" },
        { word: "healthy", pronunciation: "/ˈhelθi/", meaning: "건강한" },
        { word: "expensive", pronunciation: "/ɪkˈspensɪv/", meaning: "비싼" },
        { word: "cheap", pronunciation: "/tʃiːp/", meaning: "싼" },
        { word: "hungry", pronunciation: "/ˈhʌŋɡri/", meaning: "배고픈" }
      ]}
    ];

    // 음성 로드
    function loadVoices() {
      const voices = window.speechSynthesis.getVoices();
      englishVoice = voices.find(v => v.lang === 'en-US') || voices.find(v => v.lang.startsWith('en')) || null;
      koreanVoice = voices.find(v => v.lang === 'ko-KR') || voices.find(v => v.lang.startsWith('ko')) || null;
    }
    window.speechSynthesis.onvoiceschanged = loadVoices;

    // 카드 리셋
    function resetAllCards() {
      document.querySelectorAll('.word-card').forEach(card => {
        const slider = card.querySelector('.card-slider');
        const nav = card.querySelector('.navigation');
        slider.style.transform = `translateX(-${defaultFaceIndex * 33.333}%)`;
        nav.querySelectorAll('.nav-dot').forEach((d, i) => d.classList.toggle('active', i === defaultFaceIndex));
      });
    }

    // 앱 초기화
    function initializeApp() {
      const container = document.getElementById('chapters-list');
      container.innerHTML = '';
      
      vocabData.forEach((chapter, idx) => {
        const chapDiv = document.createElement('div');
        chapDiv.className = 'chapter-container';

        const title = document.createElement('div');
        title.className = 'chapter-title';
        title.innerHTML = `
          <span>${chapter.title}</span>
          <button class="generate-btn">문장 만들기</button>
          <span class="chapter-toggle">▼</span>
        `;

        const sentenceDisplay = document.createElement('div');
        sentenceDisplay.className = 'sentence-display';

        const wordsDiv = document.createElement('div');
        wordsDiv.className = 'words-container';
        if (idx === 0) {
          wordsDiv.classList.add('expanded');
          title.querySelector('.chapter-toggle').textContent = '▲';
        }

        chapter.words.forEach(word => wordsDiv.appendChild(createWordCard(word)));

        title.addEventListener('click', e => {
          if (e.target.classList.contains('generate-btn')) return;
          wordsDiv.classList.toggle('expanded');
          title.querySelector('.chapter-toggle').textContent = wordsDiv.classList.contains('expanded') ? '▲' : '▼';
        });

        title.querySelector('.generate-btn').addEventListener('click', e => {
          const btn = e.target;
          generateSentenceWithLocalAI(chapter.words, sentenceDisplay, btn);
        });

        chapDiv.append(title, sentenceDisplay, wordsDiv);
        container.append(chapDiv);
      });
    }

    // 단어 카드 생성
    function createWordCard(data) {
      const card = document.createElement('div');
      card.className = 'word-card';
      
      const slider = document.createElement('div');
      slider.className = 'card-slider';
      
      let currentIndex = defaultFaceIndex;
      const faces = [
        { cls: 'word-face', text: data.word },
        { cls: 'pronunciation-face', text: data.pronunciation },
        { cls: 'meaning-face', text: data.meaning }
      ];

      faces.forEach(face => {
        const div = document.createElement('div');
        div.className = `card-face ${face.cls}`;
        div.innerHTML = `<div class="${face.cls.replace('-face','')}-text">${face.text}</div>`;
        slider.appendChild(div);
      });

      slider.style.transform = `translateX(-${currentIndex * 33.333}%)`;

      const nav = document.createElement('div');
      nav.className = 'navigation';
      faces.forEach((_, i) => {
        const dot = document.createElement('div');
        dot.className = i === currentIndex ? 'nav-dot active' : 'nav-dot';
        dot.dataset.idx = i;
        dot.addEventListener('click', e => {
          e.stopPropagation();
          currentIndex = i;
          slider.style.transform = `translateX(-${i * 33.333}%)`;
          nav.querySelectorAll('.nav-dot').forEach((d, di) => d.classList.toggle('active', di === i));
          if (i === 0 && 'speechSynthesis' in window) {
            const utter = new SpeechSynthesisUtterance(faces[i].text);
            if (englishVoice) utter.voice = englishVoice;
            speechSynthesis.speak(utter);
          }
        });
        nav.appendChild(dot);
      });

      card.append(slider, nav);
      card.addEventListener('click', () => {
        currentIndex = (currentIndex + 1) % faces.length;
        slider.style.transform = `translateX(-${currentIndex * 33.333}%)`;
        nav.querySelectorAll('.nav-dot').forEach((d, di) => d.classList.toggle('active', di === currentIndex));
        if (currentIndex === 0 && 'speechSynthesis' in window) {
          const utter = new SpeechSynthesisUtterance(faces[currentIndex].text);
          if (englishVoice) utter.voice = englishVoice;
          speechSynthesis.speak(utter);
        }
      });

      return card;
    }

    // 온디바이스 AI 문장 생성 (매번 다른 문장)
    async function generateSentenceWithLocalAI(wordList, displayElement, buttonElement) {
      buttonElement.disabled = true;
      displayElement.style.display = 'block';

      try {
        if (!generator) {
          displayElement.innerHTML = '<div class="sentence-text">AI 모델을 처음 로드하는 중입니다... (약 10~20초 소요)</div>';
          const { pipeline } = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1');
          generator = await pipeline('text-generation', 'Xenova/distilgpt2');
        }

        displayElement.innerHTML = '<div class="sentence-text">AI가 새로운 문장을 생성하고 있습니다...</div>';

        const availableWords = wordList.map(item => item.word.toLowerCase().split(' ')[0]);
        const uniqueWords = [...new Set(availableWords)];

        // 랜덤 요소 추가로 매번 다른 문장 생성
        const randomPrompts = [
          `Write a simple sentence using these words: ${uniqueWords.slice(0, 5).join(', ')}.`,
          `Create a short sentence with: ${uniqueWords.slice(2, 7).join(', ')}.`,
          `Make a basic sentence using: ${uniqueWords.slice(1, 6).join(', ')}.`,
          `Form a sentence with these words: ${uniqueWords.slice(0, 4).join(', ')}.`
        ];
        
        const randomIndex = Math.floor(Math.random() * randomPrompts.length);
        const prompt = randomPrompts[randomIndex];

        const result = await generator(prompt, {
          max_new_tokens: 15,
          temperature: 0.8,      // 높은 온도로 창의성 증가
          do_sample: true,       // 샘플링으로 다양성 확보
          top_k: 50,            // 상위 50개 단어에서 선택
          num_return_sequences: 1,
          pad_token_id: 50256,  // GPT-2 모델의 패딩 토큰
        });

        let generatedSentence = result[0].generated_text;
        
        // 프롬프트 제거
        if (generatedSentence.includes('.')) {
          const sentences = generatedSentence.split('.');
          generatedSentence = sentences[sentences.length - 2] + '.';
        }
        
        generatedSentence = generatedSentence.replace(prompt, '').trim();
        
        if (!generatedSentence || generatedSentence.length < 5) {
          const fallbackSentences = [
            "I love special days.",
            "Today is sunny and nice.",
            "We buy fresh apples.",
            "My mom makes delicious food.",
            "The weather is beautiful today."
          ];
          generatedSentence = fallbackSentences[Math.floor(Math.random() * fallbackSentences.length)];
        }

        // 번역 (간단한 번역 매핑)
        const translations = {
          "I love special days.": "나는 특별한 날들을 좋아합니다.",
          "Today is sunny and nice.": "오늘은 맑고 좋은 날입니다.",
          "We buy fresh apples.": "우리는 신선한 사과를 삽니다.",
          "My mom makes delicious food.": "우리 엄마는 맛있는 음식을 만듭니다.",
          "The weather is beautiful today.": "오늘 날씨는 아름답습니다."
        };

        const koreanTranslation = translations[generatedSentence] || "생성된 문장의 한국어 번역";

        displayElement.innerHTML = `
          <div class="sentence-text">${generatedSentence}</div>
          <div class="korean-translation">${koreanTranslation}</div>
          <div class="sentence-controls">
            <button class="tts-btn" onclick="speakText('${generatedSentence}', 'en')">🔊 영어로 읽기</button>
            <button class="tts-btn" onclick="speakText('${koreanTranslation}', 'ko')">🔊 한국어로 읽기</button>
          </div>
        `;

      } catch (error) {
        console.error('AI 문장 생성 오류:', error);
        displayElement.innerHTML = '<div class="sentence-text">문장 생성에 실패했습니다. 다시 시도해주세요.</div>';
      } finally {
        buttonElement.disabled = false;
      }
    }

    // TTS 함수
    function speakText(text, lang) {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        if (lang === 'en' && englishVoice) {
          utterance.voice = englishVoice;
        } else if (lang === 'ko' && koreanVoice) {
          utterance.voice = koreanVoice;
        }
        utterance.lang = lang === 'en' ? 'en-US' : 'ko-KR';
        speechSynthesis.speak(utterance);
      }
    }

    // 전역 함수로 등록
    window.speakText = speakText;

    // 언어 탭 이벤트
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        defaultFaceIndex = parseInt(btn.dataset.face);
        initializeApp();
      });
    });
  </script>
</body>
</html>
